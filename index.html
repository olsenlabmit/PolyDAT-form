<!doctype html>

<html>
    <head>

        <!-- jquery -->
        <!--<script type="text/javascript" src="http://code.jquery.com/jquery-1.12.4.min.js"></script>-->
        <script src="jquery/jquery-3.4.1.min.js"></script>
        <!-- bootstrap -->
        <!--<link rel='stylesheet' href='http://cdn.jsdelivr.net/bootstrap/3.2.0/css/bootstrap.css'>-->
        <!-- Font Awesome icons (Bootstrap, Foundation, and jQueryUI also supported) -->
        <!--<link rel='stylesheet' href='http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.css'>-->
        <!-- JSON editor -->
        <!-- <script src="jsoneditor/jsoneditor-1.4.0-beta.0.min.js"></script> -->
        <script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@1.3.5/dist/jsoneditor.min.js"></script>
        <script src="schema/BigSMILES_DataForm_schema_production.json"></script>
        <!--<script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@1.3.5/dist/jsoneditor.min.js"></script>-->
        <!-- Compiled and minified CSS -->
        <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"> -->

        <style>
          label {
            font-size: 18px;
          }
          #speciesArray,#transArray {
            display: none;
          }
          [data-schemapath='root.BigSMILES'] label {
            font-size: 18px;
          }
          [data-schemapath='root.id'] label {
            font-size: 18px;
          }
          [data-schemapath='root.src'] label {
            font-size: 18px;
          }
          .ui-state-active {
            background: #a4bfeb;
          }
          [data-schemapath$="author_id"] thead {
            display:none;
          }
          [data-schemapath=$'author_id'] div table tbody tr td span {
            background: yellow;
          }
          [data-schemapath='root'] h3 .ui-buttonset {
            display: none;
          }
          #json_show_container{
            display: none;
          }
          #json_show {
            padding: 15px;
            margin-left: 30px;
            margin-top: 20px;
            margin-bottom: 100px;
            position: relative;
            width: 800px;
            top:-50px;
          }
          #container {
            background: white;
            border:1px none;
            width:1200px;
            margin-bottom:150px;
          }
          #submit{
            position: relative;
            top:-50px;
          }
        </style>

    </head>
    <script>
      function newWindow() {
        window.open("test2.html","_blank");
      }
    </script>

    <body>

      <div id="container">
        <div id='editor_holder'></div>
        <button id="submit">Get JSON form</button>
        <button id="b1" onclick="newWindow()">Get JSON form</button>
        <div id="bb">123</div>
        <div id="json_show_container">
          <textarea id="json_show" rows=20></textarea>
        </div>
      </div> <!-- container -->

      <script>
        //var schema;


        var editor;
        var species = [];
        var transformations = [];
/*
        $( "body" ).on("DOMNodeInserted",function( event ){
          $("span:contains('Object Properties')").html("Select Property");
          $("textarea").css('width','500px');
          $("textarea").css('height','150px');
          $("#json_show").css('width','800px');
          $("#json_show").css('height','400px');

          //$("data-schemapath='root'").children("h3").css('display','none');
          //$("div[data-schemapath^='root.data']").find("span:contains('Select Property')").parent().css('display','inline-block');
          //$("div[data-schemapath^='root']").find("span:contains('Select Property')").parent().parent().css('display','inline-block');

        });
*/
        schema = schema;
        // initiate JSON editor
        //JSONEditor.defaults.options.template = 'handlebars';
        //JSONEditor.defaults.callbacks.template = {
        //  "enumValueCB": (editor, e) => e.item.text.toLowerCase()
        //};
/*
        JSONEditor.defaults.callbacks.template = {
          "enumFilterCB": (editor, e) => {
            if (e.item.text.toLowerCase() == 'red') return ""; // "red" is not allowed
            return e.item.text;
          },
          "enumTitleCB": (editor, e) => e.item.text.toUpperCase(),
          "enumValueCB": (editor, e) => e.item.text.toLowerCase()
        };
        */
        editor = new JSONEditor(document.getElementById('editor_holder'), {
          //...
          schema: schema,
          disable_edit_json: true,
          prompt_before_delete: false,
          disable_array_reorder: true,
          no_additional_properties: false,
          disable_collapse: true,
          display_required_only: false,
          show_errors: "never",
          disable_properties: false,
          remove_empty_properties: false,
          show_opt_in: false,
          //template : 'ejs',
          //theme : 'html'
          //iconlib : 'jqueryui'
          theme: 'jqueryui'

          //remove_empty_properties:true,

          //template:'hogan'
          //iconlib: 'jqueryui '
          //theme: 'foundation6'
          //iconlib: "jqueryui"
          //iconlib: "jqueryui"
        });
        const watcherCallback = function (path) {
          //console.log(`field with path: [${path}] changed to [${JSON.stringify(this.getEditor(path).getValue())}]`);
          // Do something
          if(path=='root.preamble.network'){
            var str = JSON.stringify(this.getEditor(path).getValue());
            var arr = this.getEditor(path).getValue();
            //console.log(arr);

            var ts = arr.map(function(v){
              return v.split('>')[1];
            });
            ts = ts.flat();
            //console.log(ts);

            ss = arr.map(function(v){
              return [v.split('>')[0],v.split('>')[2]].join('.');
            });
            ss = ss.join('.');
            ss = ss.split('.');
            ss.push('[0]');
            var uniqueSS = [];
            $.each(ss, function(i, el){
              if($.inArray(el, uniqueSS) === -1) uniqueSS.push(el);
            });


            //console.log(ss);
            //console.log(uniqueSS);
            species = uniqueSS.sort();
            transformations = ts.sort();
            this.getEditor('root.speciesArray').setValue(species);
            this.getEditor('root.transArray').setValue(transformations);
            //this.getEditor('root.species.species_list').setValue(species);
            //console.log(this.getEditor('root.transformation.0.ID').getValue());
          }
          /*
          else if (path=='root.species') {
            var objArr = this.getEditor('root.species').getValue();
            console.log(objArr);
            for (var i=0;i<objArr.length;i++) {
              var obj = objArr[i];

              console.log(JSON.stringify(obj));
              console.log(obj.contents.)
            }

          }*/

        }
        for (let key in editor.editors) {
          if (editor.editors.hasOwnProperty(key) && key !== 'root') {
            editor.watch(key, watcherCallback.bind(editor, key));
          }
        }


        //var log = editor.getEditor('root.log');
        //var default_log = JSON.parse('[{"author_id": [""],"date": "","msg": ""}]');
        //log.setValue(default_log);
        //var data = editor.getEditor('root.data');
        //var default_data = JSON.parse('[{"target": "","source": ""}]');
        //data.setValue(default_data);

        $( "body" ).on("click","#submit",function( event ){
          //console.log(editor.getValue().stringify());
///*
          var errors = editor.validate();
/*
          if(errors.length) {
            // errors is an array of objects, each with a `path`, `property`, and `message` parameter
            // `property` is the schema keyword that triggered the validation error (e.g. "minLength")
            // `path` is a dot separated path into the JSON object (e.g. "root.path.to.field")
            //console.log(errors);
            //var object = editor.getEditor('root.id');
            //console.log(object);
            //console.log(object.schema.title);
            var errorMsg;
            errorMsg = String(errors.length)+' errors:\n';
            for(var i=0;i<errors.length;i++) {
              var object = editor.getEditor(errors[i].path);
              //console.log(object);
              errorMsg = errorMsg +"Error "+String(i)+': ';
              errorMsg = errorMsg +" : "+ object.schema.title +" : "+errors[i].message + '  (path='+errors[i].path+")" + '\n';
            }
            $("#json_show_container").css('display','block');
            $("#json_show").val(errorMsg);
          } else {
*/
            // It's valid!
            var formattedJson = editor.getValue();

            console.log(typeof formattedJson);
            console.log(typeof JSONstr);
            //var formattedJson = JSON.stringify(editor.getValue(), null, '  ');
            var trimmedJson = formattedJson;
            delete trimmedJson["speciesArray"];
            delete trimmedJson["transArray"];
            var JSONstr =  JSON.stringify(trimmedJson, null, '  ')
            $("#json_show").val(JSONstr);
            $("#json_show_container").css('display','block');
//          }
//*/
/*
          var formattedJson = JSON.stringify(editor.getValue(), null, '  ');
          $("#json_show").val(formattedJson);
          $("#json_show_container").css('display','block');
*/
        });
        $( "body" ).on("click","#b1",function( event ){
          openChildWin();
        });

/*
        var watcherCallback = function(path) {
          console.log("field with path: [" + path + "] changed to [" + JSON.stringify(this.getEditor(path).getValue()) + "]");
          // Do something
          //alert(path);
          //console.log(path);
        }
        for (var key in editor.editors) {
          if (editor.editors.hasOwnProperty(key) && key !== 'root') {
            editor.watch(key, watcherCallback.bind(editor, key));
          }
        }

*/

      </script>
    </body>
</html>
